{% extends 'layouts/base.html' %}
{% block content %}


<div class="header bg-primary pb-6">
  <div class="container-fluid">
    <div class="header-body">
      <div class="row align-items-center py-4">
        <div class="col-lg-6 col-5">
          <h6 class="h2 text-white d-inline-block mb-0">Informacion del paciente</h6>
          <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
            <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
              <li class="breadcrumb-item"><a href="#"><i class="fas fa-home"></i></a></li>
              <li class="breadcrumb-item"><a href="/pacientes/">Pacientes</a></li>
            </ol>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="container-fluid mt--6">
  <div class="row">
    <div class="col-xl-4 order-xl-1">
      <div class="row justify-content-center">
        <div class="card card-profile">
          <div class="card-body pt-0">
            <div class="row">
              <div class="col-md-12 text-center">
                <h5 class="h3 mt-4">{{ paciente.primer_nombre }} {{ paciente.segundo_nombre }}
                  {{paciente.primer_apellido }} {{ paciente.segundo_apellido }}</h5>
                <p class="h6 text-muted">
                  <i class="ni business_briefcase-24 mr-2"></i>{{ paciente.escolaridad }}
                </p>
                <div class="mt-3">
                  <form method="POST">
                    {% csrf_token %}
                    <div class="form-group">
                      <label for="proyecto">Seleccionar Proyecto</label>
                      <select name="proyecto_id" id="proyecto" class="form-control" required>
                        <option value="-"></option>
                        {% for proyecto in proyectos_disponibles %}
                        <option value="{{ proyecto.id }}">{{ proyecto.nombre }}</option>
                        {% endfor %}
                      </select>
                      <input type="hidden" name="paciente_id" value="{{ paciente.id }}">
                    </div>

                    <button type="submit" class="btn btn-sm btn-neutral"
                      onclick="return confirm('¿Estás seguro de que deseas agregar el paciente al proyecto?');">Agregar
                      al proyecto</button>

                  </form>
                </div>
              </div>
            </div>

            <div class="row mt-4">
              <div class="col-md-6">
                <strong>Tipo de Documento:</strong>
                <p>{{ paciente.tipo_documento }}</p>
              </div>
              <div class="col-md-6">
                <strong>Número de Documento:</strong>
                <p>{{ paciente.numero_documento }}</p>
              </div>
            </div>
            <div class="row mt-4">
              <div class="col-md-6">
                <strong>Fecha de Nacimiento:</strong>
                <p>{{ paciente.fecha_nacimiento }}</p>
              </div>
              <div class="col-md-6">
                <strong>Edad:</strong>
                <p>{{ paciente.edad }}</p>
              </div>
            </div>
            <div class="row mt-4">
              <div class="col-md-6">
                <strong>Estado Civil:</strong>
                <p>{{ paciente.estado_civil }}</p>
              </div>
              <div class="col-md-6">
                <strong>EPS:</strong>
                <p>{{ paciente.eps }}</p>
              </div>
            </div>
            <div class="row mt-4">
              <div class="col-md-6">
                <strong>Dirección:</strong>
                <p>{{ paciente.direccion }}</p>
              </div>
              <div class="col-md-6">
                <strong>Teléfono:</strong>
                <p>{{ paciente.celular }}</p>
              </div>
            </div>
            <div class="row mt-4">
              <div class="col-md-6">
                <strong>Grupo Sanguíneo:</strong>
                <p>{{ paciente.grupo_sanguineo }}</p>
              </div>
              <div class="col-md-6">
                <strong>Religión:</strong>
                <p>{{ paciente.religion }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-8 order-xl-2">
      <div class="card">
        <div class="card-header">
          <div class="row align-items-center">
            <div class="col-8">
              <h3 class="mb-0">Proyectos a los que se encuentra asociado</h3>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-12">
              {% for proyecto in proyectos_asociados %}
              <!-- Botón para abrir el modal de nueva visita -->
              <hr class="my-4">
              <h5 class="card-title text-uppercase text-muted mb-3">{{ proyecto.nombre }}</h5>

              <div class="mb-3">
                <button class="btn btn-primary mt-3" data-bs-toggle="modal"
                  data-bs-target="#modalAgregarVisita-{{ proyecto.id }}">
                  Agregar Visita
                </button>

              </div>

              {% for visita in visitas_paciente %}
              {% if visita.Tipo_visita.proyecto == proyecto %}
              <div class="mb-2">
                <p>
                  <strong>Visita:</strong> {{ visita.nombre }}<br>
                  <strong>Fecha:</strong> {{ visita.fecha }}<br>
                  <strong>Evaluador:</strong> {{ visita.evaluador }}<br>
                  <strong>Tipo de Visita:</strong> {{ visita.Tipo_visita.nombre }}
                </p>

                <!-- Mostrar los exámenes asociados a esta visita -->
                <div class="ms-4">
                  <h6>Exámenes realizados:</h6>
                  {% for visita_examen in visita.visita_examenes.all %}
                  <div class="mb-2">
                    <p>
                      <strong>Examen:</strong> {{ visita_examen.examen.nombre }}<br>
                    </p>
                  </div>
                  {% empty %}
                  <p>No se realizaron exámenes en esta visita.</p>
                  {% endfor %}
                </div>
              </div>

              {% endif %}
              {% empty %}
              <p>No hay visitas registradas para este proyecto.</p>
              {% endfor %}



              <!-- Modal para agregar una nueva visita -->
              <div class="modal fade" id="modalAgregarVisita-{{ proyecto.id }}" tabindex="-1"
                aria-labelledby="modalLabel" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Nueva Visita para {{ proyecto.nombre }}</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="POST" action="{% url 'crear_visita' paciente.id %}">
                      {% csrf_token %}
                      <div class="modal-body">
                        <input type="hidden" name="proyecto_id" value="{{ proyecto.id }}">

                        <div class="mb-3">
                          <label for="nombre_visita" class="form-label">Nombre de la Visita</label>
                          <input type="text" class="form-control" name="nombre" required>
                        </div>

                        <div class="mb-3">
                          <label for="tipo_visita" class="form-label">Tipo de Visita</label>
                          <select class="form-control tipo-visita" name="tipo_visita" id="visitaSelect">
                            <option value="">Seleccione un tipo de visita</option>
                            {% for visita in proyecto.visitas.all %}
                            <option value="{{ visita.id }}" data-examenes="{{ visita.examenes }}">
                              {{ visita.nombre }}
                            </option>
                            {% endfor %}
                          </select>
                        </div>

                        <div class="mb-3">
                          <h4>Exámenes Asociados:</h4>
                          <ul id="examenesLista" class="p-0"></ul>
                          <!-- El input hidden para examenes_seleccionados se agregará automáticamente mediante JavaScript -->
                        </div>


                        <div class="mb-3">
                          <label for="fecha" class="form-label">Fecha</label>
                          <input type="date" class="form-control" name="fecha" required>
                        </div>

                        <div class="mb-3">
                          <label for="evaluador" class="form-label">Evaluador</label>
                          <input type="text" class="form-control" name="evaluador">
                        </div>

                        <div class="modal-footer">
                          <button type="submit" class="btn btn-primary">Guardar Visita</button>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
              {% empty %}
              <p>No hay visitas registradas en este proyecto.</p>
              {% endfor %}
            </div>

          </div>
        </div>
      </div>
    </div>

  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var visitaSelect = document.querySelectorAll(".tipo-visita");

    visitaSelect.forEach(function (select) {
      select.addEventListener("change", function () {
        var selectedOption = this.options[this.selectedIndex];
        var examenesData = selectedOption.getAttribute("data-examenes");
        console.log("Data-Examenes (crudo):", examenesData);

        // Encontrar el formulario correcto - buscar el formulario padre de este select
        var currentForm = this.closest("form");
        var examenesLista = currentForm.querySelector("#examenesLista");

        if (!examenesLista) {
          console.error("No se encontró el elemento #examenesLista en este formulario");
          return;
        }

        examenesLista.innerHTML = ""; // Limpiar la lista antes de actualizar

        if (examenesData) {
          try {
            // Reemplazar comillas simples por comillas dobles
            var jsonString = examenesData.replace(/'/g, '"');
            var examenes = JSON.parse(jsonString);
            console.log("Exámenes parseados:", examenes);

            // Crear un campo oculto para almacenar los IDs seleccionados
            var hiddenInputId = "examenes_seleccionados";
            var hiddenInput = currentForm.querySelector("#" + hiddenInputId);

            // Si no existe el campo oculto, crearlo
            if (!hiddenInput) {
              hiddenInput = document.createElement("input");
              hiddenInput.type = "hidden";
              hiddenInput.name = "examenes_seleccionados";
              hiddenInput.id = hiddenInputId;
              currentForm.appendChild(hiddenInput);
              console.log("Campo oculto creado:", hiddenInput);
            }

            examenes.forEach(function (examen) {
              var li = document.createElement("li");
              li.style.listStyleType = "none";
              li.style.margin = "5px 0";

              // Crear el checkbox
              var checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.id = "examen_" + examen.id;
              checkbox.value = examen.id;
              checkbox.className = "form-check-input examen-checkbox";
              checkbox.style.marginRight = "8px";
              checkbox.checked = true; // Marcar por defecto

              // Crear la etiqueta para el checkbox
              var label = document.createElement("label");
              label.htmlFor = "examen_" + examen.id;
              label.textContent = examen.nombre;
              label.className = "form-check-label";

              // Añadir elementos al DOM
              li.appendChild(checkbox);
              li.appendChild(label);
              examenesLista.appendChild(li);

              // Agregar evento al checkbox
              checkbox.addEventListener("change", function () {
                actualizarExamenesSeleccionados(currentForm);
              });
            });

            // Inicializar la lista de exámenes seleccionados
            actualizarExamenesSeleccionados(currentForm);

          } catch (error) {
            console.error("Error al parsear los exámenes:", error);
          }
        }
      });
    });

    // Función para actualizar el campo oculto con los IDs de exámenes seleccionados
    function actualizarExamenesSeleccionados(form) {
      var checkboxes = form.querySelectorAll('.examen-checkbox:checked');
      var examenesSeleccionados = Array.from(checkboxes).map(function (cb) {
        return cb.value;
      });

      var hiddenInput = form.querySelector("#examenes_seleccionados");
      if (hiddenInput) {
        // Actualizar el campo oculto con los IDs seleccionados como JSON
        hiddenInput.value = JSON.stringify(examenesSeleccionados);
        console.log("Exámenes seleccionados:", examenesSeleccionados);
        console.log("Campo oculto:", hiddenInput);
        console.log("Valor del campo:", hiddenInput.value);
      } else {
        console.error("No se encontró el campo oculto examenes_seleccionados");
      }
    }
  });
</script>

{% endblock %}