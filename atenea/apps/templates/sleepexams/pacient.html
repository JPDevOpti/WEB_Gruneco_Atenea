{% extends 'layouts/base.html' %}
{% block content %}


<div class="header bg-primary pb-6">
  <div class="container-fluid">
    <div class="header-body">
      <div class="row align-items-center py-4">
        <div class="col-lg-6 col-5">
          <h6 class="h2 text-white d-inline-block mb-0">Informacion del paciente</h6>
          <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
            <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
              <li class="breadcrumb-item"><a href="#"><i class="fas fa-home"></i></a></li>
              <li class="breadcrumb-item"><a href="/pacientes/">Pacientes</a></li>
            </ol>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="container-fluid mt--6">
  <div class="row">
    <div class="col-xl-4 order-xl-1">
      <div class="row justify-content-center">
        <div class="card card-profile">
          <div class="card-body pt-0">
            <div class="row">
              <div class="col-md-12 text-center">
                <h5 class="h3 mt-4">{{ paciente.primer_nombre }} {{ paciente.segundo_nombre }}
                  {{paciente.primer_apellido }} {{ paciente.segundo_apellido }}</h5>
                <p class="h6 text-muted">
                  <i class="ni business_briefcase-24 mr-2"></i>{{ paciente.escolaridad }}
                </p>
                <div class="mt-3">
                  <form method="POST">
                    {% csrf_token %}
                    <div class="form-group">
                      <label for="proyecto">Seleccionar Proyecto</label>
                      <select name="proyecto_id" id="proyecto" class="form-control" required>
                        <option value="-"></option>
                        {% for proyecto in proyectos_disponibles %}
                        <option value="{{ proyecto.id }}">{{ proyecto.nombre }}</option>
                        {% endfor %}
                      </select>
                      <input type="hidden" name="paciente_id" value="{{ paciente.id }}">
                    </div>

                    <button type="submit" class="btn btn-sm btn-neutral"
                      onclick="return confirm('¿Estás seguro de que deseas agregar el paciente al proyecto?');">Agregar
                      al proyecto</button>

                  </form>
                </div>
              </div>
            </div>

            <div class="row mt-4">
              <div class="col-md-6">
                <strong>Tipo de Documento:</strong>
                <p>{{ paciente.tipo_documento }}</p>
              </div>
              <div class="col-md-6">
                <strong>Número de Documento:</strong>
                <p>{{ paciente.numero_documento }}</p>
              </div>
            </div>
            <div class="row mt-4">
              <div class="col-md-6">
                <strong>Fecha de Nacimiento:</strong>
                <p>{{ paciente.fecha_nacimiento }}</p>
              </div>
              <div class="col-md-6">
                <strong>Edad:</strong>
                <p>{{ paciente.edad }}</p>
              </div>
            </div>
            <div class="row mt-4">
              <div class="col-md-6">
                <strong>Estado Civil:</strong>
                <p>{{ paciente.estado_civil }}</p>
              </div>
              <div class="col-md-6">
                <strong>EPS:</strong>
                <p>{{ paciente.eps }}</p>
              </div>
            </div>
            <div class="row mt-4">
              <div class="col-md-6">
                <strong>Dirección:</strong>
                <p>{{ paciente.direccion }}</p>
              </div>
              <div class="col-md-6">
                <strong>Teléfono:</strong>
                <p>{{ paciente.celular }}</p>
              </div>
            </div>
            <div class="row mt-4">
              <div class="col-md-6">
                <strong>Grupo Sanguíneo:</strong>
                <p>{{ paciente.grupo_sanguineo }}</p>
              </div>
              <div class="col-md-6">
                <strong>Religión:</strong>
                <p>{{ paciente.religion }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-8 order-xl-2">
      <div class="card">
        <div class="card-header">
          <div class="row align-items-center">
            <div class="col-8">
              <h3 class="mb-0">Proyectos a los que se encuentra asociado</h3>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-12">
              {% for proyecto in proyectos_asociados %}
              <!-- Botón para abrir el modal de nueva visita -->
              <h5 class="card-title text-uppercase text-muted mb-3">{{ proyecto.nombre }}</h5>

              <div class="mb-3">
                <button class="btn btn-primary mt-3" data-bs-toggle="modal"
                  data-bs-target="#modalAgregarVisita-{{ proyecto.id }}">
                  Agregar Visita
                </button>
                <hr class="my-4">
              </div>


              {% for visita in proyecto.visitas.all %}

              <!-- Modal para agregar una nueva visita -->
              <div class="modal fade" id="modalAgregarVisita-{{ proyecto.id }}" tabindex="-1"
                aria-labelledby="modalLabel" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Nueva Visita para {{ proyecto.nombre }}</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="POST" action="{% url 'crear_visita' paciente.id %}">
                      {% csrf_token %}
                      <div class="modal-body">
                        <input type="hidden" name="proyecto_id" value="{{ proyecto.id }}">

                        <div class="mb-3">
                          <label for="nombre_visita" class="form-label">Nombre de la Visita</label>
                          <input type="text" class="form-control" name="nombre" required>
                        </div>

                        <div class="mb-3">
                          <label for="tipo_visita" class="form-label">Tipo de Visita</label>
                          <select class="form-control tipo-visita" name="tipo_visita"
                            data-proyecto-id="{{ proyecto.id }}" required>
                            <option value="">Seleccione un tipo de visita</option>

                            {% for visita in proyecto.visitas.all %}
                            <option value="{{ visita.id }}" data-examenes='[{% for examen in visita.examenes %}{"id": "{{ examen }}", "nombre": "{{ examen }}"}
                              {% if not forloop.last %}, {% endif %}{% endfor %}]'>
                              {{ visita.nombre }}</option>

                            {% endfor %}

                          </select>
                        </div>


                        <div class="mb-3">
                          <label for="fecha" class="form-label">Fecha</label>
                          <input type="date" class="form-control" name="fecha" required>
                        </div>

                        <div class="mb-3">
                          <label for="evaluador" class="form-label">Evaluador</label>
                          <input type="text" class="form-control" name="evaluador">
                        </div>

                        <!-- Exámenes asociados al tipo de visita (se llenará con JS) -->
                        <div class="mb-3">
                          <label>Exámenes Asociados</label>
                          <div class="examenes-container" id="examenes-container-{{ proyecto.id }}">
                            <p>Seleccione un tipo de visita para ver los exámenes.</p>
                          </div>
                        </div>
                      </div>

                      <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Guardar Visita</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
              {% empty %}
              <p>No hay visitas registradas en este proyecto.</p>
              {% endfor %}

              {% empty %}
              <p>El paciente no está asociado a ningún proyecto.</p>
              {% endfor %}
            </div>

          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".tipo-visita").forEach(select => {
      select.addEventListener("change", function () {
        let proyectoId = this.getAttribute("data-proyecto-id");
        let examenesContainer = document.getElementById(`examenes-container-${proyectoId}`);
        let selectedOption = this.options[this.selectedIndex];
        let examenes = JSON.parse(selectedOption.getAttribute("data-examenes") || "[]");

        // Limpiar el contenedor
        examenesContainer.innerHTML = "";

        if (examenes.length > 0) {
          examenes.forEach(examen => {
            let checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.name = "examenes[]";
            checkbox.value = examen.id;
            checkbox.classList.add("form-check-input");

            let label = document.createElement("label");
            label.classList.add("form-check-label");
            label.textContent = examen.nombre;

            let div = document.createElement("div");
            div.classList.add("form-check");
            div.appendChild(checkbox);
            div.appendChild(label);

            examenesContainer.appendChild(div);
          });
        } else {
          examenesContainer.innerHTML = "<p>No hay exámenes asignados para este tipo de visita.</p>";
        }
      });
    });
  });

</script>
{% endblock %}